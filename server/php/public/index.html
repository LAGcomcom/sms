<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>短信转发系统</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto;max-width:960px;margin:24px auto;padding:0 16px}
h1{font-size:20px;margin:0 0 12px}
.card{border:1px solid #ddd;border-radius:8px;padding:12px;margin-bottom:16px}
.row{display:flex;gap:12px}
.col{flex:1}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #eee;padding:8px;text-align:left}
.online{color:#0a7}
.offline{color:#d33}
input,select{padding:6px 8px;border:1px solid #ccc;border-radius:6px}
button{padding:6px 10px;border:0;background:#0a7;color:#fff;border-radius:6px}
</style>
</head>
<body>
<h1>短信转发系统</h1>
<div class="card">
  <div class="row">
    <div class="col">
      <label>设备ID</label>
      <input id="deviceId" placeholder="如 dev1"/>
    </div>
    <div class="col">
      <label>Token</label>
      <input id="token" placeholder="URL 中可用 ?token=..."/>
    </div>
    <div class="col">
      <label>号码</label>
      <input id="phone" placeholder="如 +8613812345678"/>
    </div>
    <div class="col">
      <label>时间范围</label>
      <input id="from" type="datetime-local"/>
      <input id="to" type="datetime-local"/>
    </div>
    <div class="col" style="align-self:end">
      <button id="refresh">查询</button>
      <button id="register">注册并获取Token</button>
    </div>
  </div>
</div>

<div class="card">
  <h2>设备状态</h2>
  <table>
    <thead><tr><th>设备ID</th><th>号码</th><th>最后心跳</th><th>状态</th></tr></thead>
    <tbody id="devices"></tbody>
  </table>
  <div id="offlineAlert" style="display:none;color:#d33;margin-top:8px">有设备离线超过30秒</div>
</div>

<div class="card">
  <h2>短信列表</h2>
  <table>
    <thead><tr><th>ID</th><th>设备</th><th>号码</th><th>发送方</th><th>接收时间</th></tr></thead>
    <tbody id="messages"></tbody>
  </table>
</div>

<script>
const qs=new URLSearchParams(location.search);const tokenInput=document.getElementById('token');tokenInput.value=qs.get('token')||'';if(!tokenInput.value) tokenInput.value='devtoken';
const deviceInput=document.getElementById('deviceId');
function hdr(){const t=tokenInput.value.trim();return t?{Authorization:'Bearer '+t}:{}};
async function loadDevices(){const r=await fetch('/api/devices.php',{headers:hdr()});if(!r.ok){return;}const j=await r.json();renderDevices(j.data||[]);} 
function renderDevices(list){const tb=document.getElementById('devices');tb.innerHTML='';let anyOffline=false;list.forEach(x=>{const tr=document.createElement('tr');const st=x.online?'<span class="online">在线</span>':'<span class="offline">离线</span>';if(!x.online) anyOffline=true;tr.innerHTML=`<td>${x.device_id}</td><td>${x.phone_number||''}</td><td>${x.last_heartbeat||''}</td><td>${st}</td>`;tb.appendChild(tr)});document.getElementById('offlineAlert').style.display=anyOffline?'block':'none';}
async function loadMessages(){const phone=document.getElementById('phone').value.trim();const from=document.getElementById('from').value;const to=document.getElementById('to').value;const p=new URLSearchParams();if(phone)p.set('phone',phone);if(from)p.set('from',from.replace('T',' '));if(to)p.set('to',to.replace('T',' '));p.set('limit','50');const r=await fetch('/api/messages.php?'+p.toString(),{headers:hdr()});if(!r.ok){return;}const j=await r.json();const tb=document.getElementById('messages');tb.innerHTML='';(j.data||[]).forEach(x=>{const tr=document.createElement('tr');tr.style.cursor='pointer';tr.addEventListener('click',()=>showDetail(x.message_id));tr.innerHTML=`<td>${x.message_id}</td><td>${x.device_id}</td><td>${x.phone_number||''}</td><td>${x.sender||''}</td><td>${x.receive_time||''}</td>`;tb.appendChild(tr)});} 
async function showDetail(id){const r=await fetch('/api/message_detail.php?id='+id,{headers:hdr()});if(!r.ok){return;}const j=await r.json();if(j.data){alert('短信内容:\n'+(j.data.content||''));}}
document.getElementById('refresh').addEventListener('click',()=>{loadDevices();loadMessages()});
document.getElementById('register').addEventListener('click',async()=>{
  const dev=deviceInput.value.trim();const phone=document.getElementById('phone').value.trim();
  if(!dev||!phone) return alert('请填写设备ID与号码');
  const r=await fetch('/api/auth/register_device.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({device_id:dev,phone_number:phone})});
  const j=await r.json(); if(j.token){ tokenInput.value=j.token; alert('注册成功，已获取Token'); }
});
loadDevices();loadMessages();
let es;try{const tk=tokenInput.value.trim();const url='/api/devices_stream.php'+(tk?('?token='+encodeURIComponent(tk)):'');es=new EventSource(url,{withCredentials:false});es.onmessage=(e)=>{};es.addEventListener('devices',(ev)=>{try{const data=JSON.parse(ev.data);renderDevices(data)}catch{}});es.onerror=()=>{if(es){es.close();}};}catch{}
setInterval(()=>{if(!es||es.readyState===2){loadDevices();}loadMessages()},5000);
</script>
</body>
</html>
